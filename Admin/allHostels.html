<!DOCTYPE html>
<html>

<head>
    <title>My Hostels</title>
    <link rel="stylesheet" href="css/navBar.css">
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/loader.css">
</head>

<body>

    <nav class="navbar">
        <div class="logo">HostelManager</div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search hostel by name or location...">
        </div>
        <ul>
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="allHostels.html">My Hostels</a></li>
            <li><a href="addHostel.html">Add Hostel</a></li>
            <li><a id="logoutBtn" style="cursor:pointer;">Logout</a></li>
        </ul>
    </nav>
    <div class="hostel-container" id="hostelContainer"></div>



</body>
<script src="api/api.js"></script>
<script src="api/hostels.js"></script>
<script src="api/room.js"></script>
<script src="api/student.js"></script>
<script src="api/dashboardHelper.js"></script>
<script>
    const manager = JSON.parse(localStorage.getItem('managerData')) || [];
    const container = document.getElementById("hostelContainer");

    //========= SECURITY ==========
    refreshLocalStorageAndStats(manager[0].id);
    (() => {
        if (!manager || manager.length === 0) {
            window.open('login.html', '_self')
        }
    })();

    document.getElementById('logoutBtn').onclick = () => {
        localStorage.removeItem('managerData');
        window.open('login.html', '_self');
    };

    let hostels = null;
    let rooms = null;
    let students = null;

    //========== Fetch Data from localStorage ============
    function getHostels() {
        return JSON.parse(localStorage.getItem('totHostels')) || [];
    }

    function getRooms() {
        return JSON.parse(localStorage.getItem('totRooms')) || [];
    }

    function getStudents() {
        return JSON.parse(localStorage.getItem('totStudents')) || [];
    }

    //=======
    function getLoadata() {
        loader();
        makeCards();
    }
    getLoadata();


    function loader() {
        container.innerHTML = `
        <div class="loader-overlay">
            <div class="loader-box">
                <div class="loader-spinner"></div>
                Loading please wait...
            </div>
        </div>`;
    }

    //============= Hostel Dropdown + Rooms list ===============
    function makeCards() {
        container.innerHTML = '';
        getHostels().forEach(hostel => {
            const hostelCard = document.createElement("div");
            hostelCard.className = "hostel-card";

            //========== Dropdown Head ================
            const header = document.createElement("div");
            header.className = "hostel-header";
            header.innerHTML = `
                <div>
                    <h3>${hostel.name}</h3>
                    <p style="margin:4px 0;font-size:14px;">
                        ${hostel.location}
                    </p>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <span>Rooms: ${getRooms().filter(room => room.hostelId === hostel.id).length} ||
                    <span>ID: ${hostel.id}</span>
                    <button class="view-rooms-btn" onclick=viewAllRooms(${hostel.id}) >View All Rooms</button>
                    <button class="update-rooms-btn" onclick='makeEditForm(${JSON.stringify(hostel)})'>Edit</button>
                    <button class="delete-rooms-btn" onclick='dltHostel(${hostel.id})'>Delete</button>
                </div>
            `;

            //============== Dropdown Body ===============
            const dropdown = document.createElement("div");
            dropdown.className = "room-dropdown";

            dropdown.innerHTML = `<p><b>${hostel.location}</b></p>`;

            getRooms()
                .filter(room => room.hostelId === hostel.id)
                .forEach(room => {
                    dropdown.innerHTML += `
                        <div class="room-card">
                            <p><b>Room No:</b> ${room.roomNo}</p>
                            <p><b>Capacity:</b> ${room.capacity}</p>
                            <p><b>Occupied:</b> ${room.occupied}</p>
                            <p><b>Price:</b> â‚¹${room.price}</p>
                        </div>
                    `;
                });

            header.addEventListener("click", () => {
                dropdown.style.display =
                    dropdown.style.display === "block" ? "none" : "block";
            });

            hostelCard.append(header, dropdown);
            container.appendChild(hostelCard);
        });
    }

    //======== View Rooms Logic ==========
    function viewAllRooms(hid) {
        loader();
        collectRooms = getRooms().filter(room => room.hostelId === hid);
        localStorage.setItem('rooms', JSON.stringify(collectRooms));
        window.open('hostelRooms.html', '_self');
    }

    //=========== Edit Hostel =============
    function makeEditForm(data) {
        let div = document.createElement('div');
        div.className = "editForm";
        div.innerHTML = `
            <div class="overlay"></div>

            <form class="form" >
                <button id="cancel" class="closeBtn">X</button>

                <h2>Edit Hostel</h2>

                <input placeholder="Hostel Name" value="${data.name}">
                <input placeholder="City"  value="${data.city}">
                <input placeholder="State"  value="${data.state}">
                <input placeholder="Location"  value="${data.location}">
                <input placeholder="Price"  value="${data.price}">
                <input placeholder="Image URL"  value="${data.image}">
                <textarea placeholder="Facilities (comma separated)">${data.facilities}</textarea>

                <button type="button" onclick="editHostel(${data.id})">Edit Hostel</button>
            </form>
        `;
        container.appendChild(div);
    }

    //============= Delete Hostel ==============
    async function dltHostel(id) {
        if (confirm('Are you sure?')) {
            await deleteHostel(id);
            await deleteRoom(id);
            await deleteStudent(id);
            refreshLocalStorageAndStats(manager[0].id);
            location.reload();
        }
    }

    //========== Send Updated Hostel Data ==============
    async function editHostel(id) {
        const inputs = document.querySelectorAll(".form input, .form textarea");
        const [
            hostelName,
            city,
            state,
            location,
            price,
            imageUrl,
            facilities
        ] = Array.from(inputs).map(input => input.value.trim());

        /* Null / Empty validation */
        if (
            !hostelName ||
            !city ||
            !state ||
            !location ||
            !price ||
            !imageUrl ||
            !facilities
        ) {
            alert("All fields are required");
            return;
        }

        /* Price validation */
        if (isNaN(price) || Number(price) <= 0) {
            alert("Enter a valid price");
            return;
        }

        const hostelData = {
            managerId: manager[0].id,
            name: hostelName,
            city: city,
            state: state,
            location: location,
            price: Number(price),
            image: imageUrl,
            facilities: facilities.split(",").map(f => f.trim())
        };

        /* Call add hostel method from api/hostel.js*/
        await updateHostel(id, hostelData);
        await refreshLocalStorageAndStats(manager[0].id);
        makeCards(getHostels());
        document.querySelector(".editForm").remove();
        alert("Hostel updated successfully!");
    }

    //============ Search Hostel ==============
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchText = e.target.value.toLowerCase();
        const filtered = getHostels().filter(h =>
            h.name.toLowerCase().includes(searchText) ||
            h.location.toLowerCase().includes(searchText)
        );
        makeCards(filtered);
    });

</script>

</html>